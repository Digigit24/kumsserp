import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import { storeIndentsApi } from '../services/store.service';

export const storeIndentKeys = {
  all: ['storeIndents'] as const,
  lists: () => [...storeIndentKeys.all, 'list'] as const,
  list: (filters?: any) => [...storeIndentKeys.lists(), filters] as const,
  details: () => [...storeIndentKeys.all, 'detail'] as const,
  detail: (id: number) => [...storeIndentKeys.details(), id] as const,
};

export const useStoreIndents = (filters?: any) => {
  return useQuery({
    queryKey: storeIndentKeys.list(filters),
    queryFn: () => storeIndentsApi.list(filters),
  });
};

export const useStoreIndent = (id: number) => {
  return useQuery({
    queryKey: storeIndentKeys.detail(id),
    queryFn: () => storeIndentsApi.get(id),
    enabled: !!id,
  });
};

export const useCreateStoreIndent = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: async (data: any) => {
      console.log('=== STORE INDENT CREATE - ORIGINAL DATA ===', JSON.stringify(data, null, 2));
      
      // Deep copy to avoid mutating original data
      const cleanedData = JSON.parse(JSON.stringify(data));
      
      // Remove indent field from items (backend no longer requires it)
      if (cleanedData.items && Array.isArray(cleanedData.items)) {
        cleanedData.items = cleanedData.items.map((item: any) => {
          const { indent, ...itemWithoutIndent } = item;
          return itemWithoutIndent;
        });
      }
      
      // Convert empty strings to null for optional fields
      const optionalFields = [
        'approved_date',
        'approved_by',
        'attachments',
        'requesting_store_manager',
        'approval_request',
      ];
      
      optionalFields.forEach(field => {
        if (cleanedData[field] === '' || cleanedData[field] === null) {
          delete cleanedData[field];
        }
      });
      
      console.log('=== STORE INDENT CREATE - CLEANED DATA ===', JSON.stringify(cleanedData, null, 2));
      
      return storeIndentsApi.create(cleanedData);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.lists() });
    },
  });
};

export const useUpdateStoreIndent = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, data }: { id: number; data: any }) => {
      console.log('=== STORE INDENT UPDATE - BEFORE CLEANING ===', data);
      
      // Clean up data before sending
      const cleanedData = { ...data };
      
      // Remove indent field from items (should already be set)
      if (cleanedData.items && Array.isArray(cleanedData.items)) {
        cleanedData.items = cleanedData.items.map((item: any) => {
          const { indent, ...itemWithoutIndent } = item;
          return itemWithoutIndent;
        });
      }
      
      // Convert empty strings to null for optional fields
      const optionalFields = [
        'approved_date',
        'approved_by',
        'attachments',
        'requesting_store_manager',
        'approval_request',
      ];
      
      optionalFields.forEach(field => {
        if (cleanedData[field] === '' || cleanedData[field] === null) {
          delete cleanedData[field];
        }
      });
      
      console.log('=== STORE INDENT UPDATE - AFTER CLEANING ===', cleanedData);
      
      return storeIndentsApi.update(id, cleanedData);
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.lists() });
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.detail(variables.id) });
    },
  });
};

export const useDeleteStoreIndent = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: storeIndentsApi.delete,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.lists() });
    },
  });
};

export const useApproveStoreIndent = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, data }: { id: number; data: any }) => storeIndentsApi.approve(id, data),
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.lists() });
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.detail(variables.id) });
    },
  });
};

export const useRejectStoreIndent = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, data }: { id: number; data: any }) => storeIndentsApi.reject(id, data),
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.lists() });
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.detail(variables.id) });
    },
  });
};

export const useSubmitStoreIndent = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, data }: { id: number; data: any }) => storeIndentsApi.submit(id, data),
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.lists() });
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.detail(variables.id) });
    },
  });
};

// College Admin Approvals
export const usePendingCollegeApprovals = (filters?: any) => {
  return useQuery({
    queryKey: [...storeIndentKeys.lists(), 'pending_college', filters],
    queryFn: () => storeIndentsApi.pendingCollegeApprovals(filters),
  });
};

export const useCollegeAdminApprove = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, data }: { id: number; data: any }) => storeIndentsApi.collegeAdminApprove(id, data),
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.lists() });
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.detail(variables.id) });
    },
  });
};

export const useCollegeAdminReject = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, data }: { id: number; data: any }) => storeIndentsApi.collegeAdminReject(id, data),
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.lists() });
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.detail(variables.id) });
    },
  });
};

// Super Admin Approvals
export const usePendingSuperAdminApprovals = (filters?: any) => {
  return useQuery({
    queryKey: [...storeIndentKeys.lists(), 'pending_super_admin', filters],
    queryFn: () => storeIndentsApi.pendingSuperAdminApprovals(filters),
  });
};

export const useSuperAdminApprove = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, data }: { id: number; data: any }) => storeIndentsApi.superAdminApprove(id, data),
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.lists() });
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.detail(variables.id) });
    },
  });
};

export const useSuperAdminReject = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, data }: { id: number; data: any }) => storeIndentsApi.superAdminReject(id, data),
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.lists() });
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.detail(variables.id) });
    },
  });
};

// Material Issuance
export const useIssueMaterials = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, data }: { id: number; data: any }) => storeIndentsApi.issueMaterials(id, data),
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.lists() });
      queryClient.invalidateQueries({ queryKey: storeIndentKeys.detail(variables.id) });
    },
  });
};
